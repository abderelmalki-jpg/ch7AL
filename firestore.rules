
rules_version = '2';

// Re-deploying rules to ensure indexes are created.
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ============================================
    // üë§ USER PROFILES (/users/{userId})
    // ============================================
    match /users/{userId} {
      // Un utilisateur connect√© peut lire les profils des autres (pour les commentaires, etc.)
      allow get: if isSignedIn();
      
      // Un utilisateur peut mettre √† jour son propre profil
      allow update: if isOwner(userId);

      // Les profils sont listables pour le classement (leaderboard)
      allow list: if isSignedIn();

      // Un utilisateur peut cr√©er son propre profil
      allow create: if isOwner(userId);

      // Personne ne peut supprimer un profil via l'app cliente
      allow delete: if false;

      // ---- Sous-collection Liste de Courses ----
      match /shoppingList/{itemId} {
        allow read, list, create, update, delete: if isOwner(userId);
      }
    }

    // ============================================
    // üí∞ PRICE RECORDS (/priceRecords/{priceRecordId})
    // ============================================
    match /prices/{priceRecordId} {
      // Tout le monde peut lire les prix
      allow get, list: if true;
      
      // Seul un utilisateur connect√© peut cr√©er un prix
      // et il doit √™tre le cr√©ateur de l'enregistrement.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Les utilisateurs connect√©s peuvent voter (mettre √† jour), mais pas sur leur propre post.
      // Le propri√©taire peut supprimer son propre post.
      allow update: if isSignedIn() && resource.data.userId != request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;

      match /comments/{commentId} {
        allow read, list: if isSignedIn();
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isOwner(resource.data.userId);
      }
    }
    
    match /contributions/{contributionId} {
      allow get, list: if isSignedIn();
    }

    // ============================================
    // üè¨ STORES (/stores/{storeId})
    // ============================================
    match /stores/{storeId} {
      // Tout le monde peut lire les informations des magasins
      allow get, list: if true;
      
      // Un utilisateur connect√© peut ajouter un nouveau magasin
      allow create: if isSignedIn() && request.resource.data.addedBy == request.auth.uid;
      
      // Personne ne peut modifier ou supprimer un magasin pour le moment
      allow update, delete: if false;

      // ---- Sous-collection Avis ----
      match /reviews/{reviewId} {
        // Tout le monde peut lire les avis
        allow get, list: if true;
        // Un utilisateur connect√© peut cr√©er un avis pour un magasin
        // √† condition qu'il n'en ait pas d√©j√† post√© un (logique √† g√©rer dans la fonction Cloud)
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        // Un utilisateur peut modifier/supprimer son propre avis
        allow update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      }
    }
    
    match /products/{productId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    // ============================================
    // üèÜ BADGES (/badges/{badgeId})
    // ============================================
    match /badges/{badgeId} {
      // Les d√©finitions des badges sont publiques et en lecture seule
      allow get, list: if true;
      allow create, update, delete: if false; // G√©r√© c√¥t√© serveur (admin)
    }
  }
}
